---
import { posters } from "../../lib/posters.js";
import "../../styles/global.css";
import { getEntry } from "astro:content";

export function getStaticPaths() {
  return posters.map((p, idx) => {
    const prev = posters[idx - 1] ?? null;
    const next = posters[idx + 1] ?? null;

    return {
      params: { no: p.no3 },     // /odop/001
      props: { p, prev, next },  // 페이지에서 사용할 데이터
    };
  });
}

const { p, prev, next } = Astro.props;
const { no } = Astro.params; // "001"
const entry = await getEntry("odop", no);
const rendered = entry ? await entry.render() : null;

const Content = rendered?.Content ?? null;
const data = rendered?.data ?? {};
---

<main class="detail">
  <header class="top">
    <div class="topRow">
      <a class="back" href="/"><span aria-hidden="true">←</span> Back</a>

      <nav class="nav">
        {prev ? <a class="btn" data-nav="prev" href={`/odop/${prev.no3}`}>Prev</a> : <span class="btn disabled">Prev</span>}
        {next ? <a class="btn" data-nav="next" href={`/odop/${next.no3}`}>Next</a> : <span class="btn disabled">Next</span>}
      </nav>
    </div>

    <div class="meta">
      <div class="no">{p.title}</div>
      <time class="date" datetime={p.date}>{p.date}</time>
    </div>

    <div class="info">
      <div class="line">
        <span class="tag">[One Day One Poster]</span>
        <span class="dot">•</span>
        <span class="day">Day {data.day ?? no}</span>
      </div>

      {data.subject && (
        <div class="row">
          <span class="k">Subject</span>
          <span class="v">{data.subject}</span>
        </div>
      )}

      {Array.isArray(data.tools) && data.tools.length > 0 && (
        <div class="row">
          <span class="k">Tools</span>
          <span class="v">{data.tools.join(", ")}</span>
        </div>
      )}

      {Array.isArray(data.fonts) && data.fonts.length > 0 && (
        <div class="row">
          <span class="k">Fonts</span>
          <span class="v">{data.fonts.join(", ")}</span>
        </div>
      )}
    </div>

    {p.desc && <p class="desc">{p.desc}</p>}
  </header>

  <section class="viewer">
    <div class="stage">
      <img class="poster" src={p.img} alt={p.title} />
    </div>
  </section>

  <section class="note">
    {Content ? <Content /> : <p class="missing">행복합시다.</p>}
  </section>
</main>

<script is:inline>
  document.addEventListener("keydown", (e) => {
    if (e.key === "Escape") window.location.href = "/";
    if (e.key === "ArrowLeft") document.querySelector('[data-nav="prev"]')?.click();
    if (e.key === "ArrowRight") document.querySelector('[data-nav="next"]')?.click();
  });
</script>

<style>
  :global(body) {
    margin: 0;
    background: #090909;
    color: #f9f9f9;
  }

  .detail {
    max-width: 1100px;
    margin: 0 auto;
    padding: 24px;
  }

  .top {
    display: grid;
    gap: 14px;
    margin-bottom: 18px;
  }

  .topRow {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 12px;
  }

  .back {
    color: rgba(249, 249, 249, 0.7);
    text-decoration: none;
  }

  .nav {
    display: flex;
    gap: 8px;
  }

  .btn {
    border: 1px solid rgba(249, 249, 249, 0.22);
    padding: 10px 12px;
    font-size: var(--ui-font-size);
    border-radius: 5px;
    background: transparent;
    color: #f9f9f9;
    text-decoration: none;
    display: inline-block;
  }

  .btn.disabled {
    opacity: 0.35;
    pointer-events: none;
  }

  .meta {
    display: grid;
    gap: 6px;
  }

  .no {
    font-weight: 700;
    font-size: 32px;
    letter-spacing: -0.02em;
  }

  .date {
    color: rgba(249, 249, 249, 0.6);
    font-size: 14px;
    letter-spacing: 0.01em;
  }

  /* ✅ 정보( day/subject/tools/fonts ) 타이포 조절 */
  .info {
    display: grid;
    gap: 8px;
    max-width: 72ch;
    margin-top: 6px;
  }

  .line {
    display: flex;
    align-items: baseline;
    gap: 8px;
    font-size: 14px;
    line-height: 1.6;
    letter-spacing: 0.01em;
  }

  .tag {
    color: rgba(249, 249, 249, 0.72);
  }

  .day {
    font-weight: 600;
  }

  .row {
    display: flex;
    gap: 12px;
    font-size: 14px;
    line-height: 1.7;
    letter-spacing: 0.01em;
  }

  .k {
    min-width: 72px;
    opacity: 0.6;
    font-size: 11px;
    letter-spacing: 0.08em;
    text-transform: uppercase;
  }

  .v {
    opacity: 0.9;
  }

  .desc {
    margin: 10px 0 0;
    max-width: 72ch;
    line-height: 1.7;
    letter-spacing: 0.01em;
    color: rgba(249, 249, 249, 0.78);
    font-size: 14px;
  }

  .viewer {
    border: 0;
    padding: 12px 0 0;
  }

  .stage {
    border: 1px solid rgba(249, 249, 249, 0.12);
    background: #090909;
    padding: 10px;
  }

  .poster {
    width: 100%;
    height: auto;
    display: block;
  }

  /* ✅ Note(마크다운 본문) 타이포/행간/마진 */
  .note {
    margin-top: 18px;
    padding-top: 16px;
    border-top: 1px solid rgba(249, 249, 249, 0.12);
    max-width: 80ch;
  }

  .note :global(p) {
    margin: 0 0 12px;
    line-height: 1.8;
    letter-spacing: 0.01em;
    font-size: 16px;
  }

  .note :global(h1),
  .note :global(h2),
  .note :global(h3) {
    margin: 18px 0 10px;
    letter-spacing: -0.01em;
  }

  .note :global(ul),
  .note :global(ol) {
    margin: 0 0 12px;
    padding-left: 18px;
    line-height: 1.8;
    font-size: 16px;
  }

  .missing {
    opacity: 0.6;
    margin: 0;
  }
</style>
